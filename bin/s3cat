#!/usr/bin/env ruby

require 's3grep'
require 'aws-sdk-s3'

# Exit cleanly on broken pipe (e.g., when piping to head)
Signal.trap("PIPE", "EXIT")

s3_url = ARGV[0]

if s3_url.nil? || s3_url.empty?
  $stderr.puts "Usage: s3cat s3://bucket/path/to/file"
  exit 1
end

unless s3_url.start_with?('s3://')
  $stderr.puts "Error: Invalid S3 URL format. Expected s3://bucket/path"
  exit 1
end

begin
  # max_attempts: 1 disables retries (required for streaming)
  aws_s3_client = Aws::S3::Client.new(max_attempts: 1)
  search = S3Grep::Search.new(s3_url, aws_s3_client)
  search.to_io.each do |line|
    print line
  end
rescue Errno::EPIPE
  # Broken pipe (e.g., piping to head) - exit silently
  exit 0
rescue Aws::S3::Errors::ServiceError => e
  $stderr.puts "S3 Error: #{e.message}"
  exit 1
rescue => e
  $stderr.puts "Error: #{e.message}"
  exit 1
end
